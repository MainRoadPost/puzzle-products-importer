# Puzzle Products Importer

## Об инструменте

**puzzle-products-importer** — это небольшое приложение, которое позволяет загружать продукты в проект Puzzle из CSV-таблицы.

Этот инструмент будет полезен для заполнения продуктов больших проектов на основе данных из сметы.

## Использование

Для запуска приложения выполните в консоли команду:

```
puzzle-products-importer
```

Команда запустит оконное приложение, которое выглядит вот так:

![Интерфейс](/images/puzzle-products-importer_ui.png)

Необходимо выбрать домен и войти в систему, используя свой студийный аккаунт и пароль.

После успешного входа в систему станет доступен список проектов. Выберите нужный проект.

После этого необходимо выбрать CSV-файл. Этот файл можно создать на основе сметы проекта в Excel или в другом редакторе электронных таблиц. CSV-таблица по составу, названию и содержимому колонок должна соответствовать данному примеру-шаблону:

| path             | code  | awarded | due     | picture  | deliverable | status  |
|------------------|-------|---------|---------|----------|-------------|---------|
| episode01/24_chs | 0010  |    10   |12.11.24 | 0010.jpg | TRUE        | ACTIVE  |

- В колонке `path` необходимо указать последовательность из вложенных продуктовых групп, в которых состоит данный продукт.
- `code` — название (код) продукта, как он будет назван на сервере.
- `awarded` — количество выделенных ресурсов на шот в человеко-часах.
- `due` — срок сдачи продукта в формате ДД.ММ.ГГ.
- `picture` — путь к превью-картинке продукта; картинка должна быть квадратной 256×256 пикселей.
- `deliverable` — нужно ли сдавать продукт клиенту; возможные значения TRUE и FALSE.
- `status` — состояние продукта; возможные значения ACTIVE, COMPLETED, CANCELED.

Только первые две колонки являются необходимыми к заполнению, остальные можно оставить пустыми.

## Установка приложения

Программа устанавливается через `mrp-install`. Перед установкой необходимо инициализировать venv и установить туда зависимости из файла `requirements.txt`.

**Порядок действий:**

1. Скачайте репозиторий программы в локальную папку при помощи `git clone`.

2. Создайте виртуальную исполняемую среду venv следующей командой:

   ```bash
   python3 -m venv venv
   ```

3. Активируйте виртуальную исполняемую среду:

   ```bash
   source venv/bin/activate
   ```

4. Установите в исполняемую среду зависимости. В случае если компьютер имеет доступ в Интернет, то это делается следующим образом в запущенном venv:

   ```bash
   pip install -r requirements.txt
   ```

   Но поскольку доступа из производственной сети в Интернет, скорее всего, нет, необходимо собрать все питоновские пакеты на другой машине, имеющей выход в Интернет:

   ```bash
   mkdir offline_packages
   cd offline_packages
   pip download -r requirements.txt
   ```

5. Затем установите зависимости в виртуальную исполняемую среду при помощи команды внутри venv (предварительно перенесите папку с собранными пакетами туда, где вам удобнее; в примере папка перенесена внутрь папки с репозиторием):

   ```bash
   pip install --no-index --find-links=. -r requirements.txt
   ```

6. Далее необходимо проверить, что приложение успешно запускается. Выйдите из venv и запустите команду:

   ```bash
   ./puzzle-products-importer
   ```

   Вы должны увидеть GUI приложения, как на картинке выше.

7. В случае успеха установите программу в студийный тулсет командой:

   ```bash
   mrp-install.sh
   ```

## Изменение кода

Для общения с GraphQL-интерфейсом Puzzle программа использует клиент (модуль `puzzle`), созданный инструментом для кодогенерации **ariadne-codegen**. В случае если вам необходимо изменить функционал клиента, не нужно модифицировать вручную код модуля `puzzle`.

Вместо этого необходимо убедиться, что файл `schema.graphql` содержит актуальную модель данных, изменить файл `queries.graphql` так, чтобы он содержал необходимые запросы к БД Puzzle, после чего выполнить команду `ariadne-codegen`, чтобы обновить код модуля `puzzle`. Сам инструмент `ariadne-codegen` должен быть установлен либо в исполняемую среду, либо в venv (тогда команду кодогенерации нужно запускать из-под venv).