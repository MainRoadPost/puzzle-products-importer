# Puzzle Products Importer

## Об инструменте

**puzzle-products-importer** — это небольшое приложение, которое позволяет загружать продукты в проект Puzzle из CSV-таблицы.

Этот инструмент будет полезен для заполнения продуктов больших проектов на основе данных из сметы.

## Использование

Для запуска приложения выполните в консоли команду:

```
puzzle-products-importer
```

Команда запустит оконное приложение, которое выглядит вот так:

![Интерфейс](/images/puzzle-products-importer_ui.png)

Необходимо выбрать домен и войти в систему, используя свой студийный аккаунт и пароль.

После успешного входа в систему станет доступен список проектов. Выберите нужный проект.

После этого необходимо выбрать CSV-файл. Этот файл можно создать на основе сметы проекта в Excel или в другом редакторе электронных таблиц. CSV-таблица по составу, названию и содержимому колонок должна соответствовать данному примеру-шаблону:

| path             | code  | awarded | due        | picture          | deliverable | status  | tags      |
|------------------|-------|---------|------------|------------------|-------------|---------|-----------|
| episode01/seq01  | 0010  | 10      | 21.06.2025 | images/0010.png  | TRUE        | ACTIVE  | tag1 tag2 |
| episode01/seq01  | 0020  |         |            |                  |             |         |           |

- В колонке `path` необходимо указать последовательность из вложенных продуктовых групп, в которых состоит данный продукт.
- `code` — название (код) продукта, как он будет назван на сервере.
- `awarded` — количество выделенных ресурсов на шот в человеко-часах.
- `due` — срок сдачи продукта в формате ДД.ММ.ГГГГ.
- `due` — срок сдачи продукта в формате ДД.ММ.ГГГГ или двухзначном годе ДД.ММ.ГГ.
- `picture` — путь к превью-картинке продукта; картинка должна быть квадратной 256×256 пикселей.
- `deliverable` — нужно ли сдавать продукт клиенту; возможные значения TRUE и FALSE.
- `status` — состояние продукта; возможные значения ACTIVE, COMPLETED, CANCELED.
- `tags` — теги продукта, разделенные пробелами.

Только первые две колонки являются необходимыми к заполнению, остальные можно оставить пустыми.

Dry run
-------

Приложение поддерживает режим "Dry run", который полезен для проверки парсинга CSV и подготовки GraphQL-мутей без фактического создания или изменения продуктов на сервере. При включенном флажке Dry run приложение подготовит и залогирует данные `ProductAdd` и `ProductChange`, но не будет отправлять их в API.

## Установка приложения

Для управления зависимостями и сборкой проекта используется инструмент **uv**. Убедитесь, что он установлен в вашей системе.

**Порядок действий:**

1. Скачайте репозиторий программы в локальную папку при помощи `git clone`.

2. Установите зависимости проекта при помощи `uv`:

   ```bash
   uv sync
   ```

3. **Важно:** Перед первым запуском приложения необходимо сгенерировать GraphQL-клиент при помощи `ariadne-codegen`. Выполните команду:

   ```bash
   uv run ariadne-codegen
   ```

   Эта команда создаст/обновит модуль `puzzle` на основе файлов `schema.graphql` и `queries.graphql`.

4. Проверьте, что приложение успешно запускается:

   ```bash
   uv run puzzle-products-importer
   ```

   Вы должны увидеть GUI приложения, как на картинке выше.

5. В случае успеха установите программу в студийный тулсет командой:

   ```bash
   mrp-install.sh
   ```

## Тесты

Для запуска тестов проекта используйте `uv` и стандартный тестовый раннер Python:

```bash
uv run python -m unittest discover -v
```

## Изменение кода

Для общения с GraphQL-интерфейсом Puzzle программа использует клиент (модуль `puzzle`), созданный инструментом для кодогенерации **ariadne-codegen**. В случае если вам необходимо изменить функционал клиента, не нужно модифицировать вручную код модуля `puzzle`.

Вместо этого необходимо:

1. Убедиться, что файл `schema.graphql` содержит актуальную модель данных.
2. Изменить файл `queries.graphql` так, чтобы он содержал необходимые запросы к БД Puzzle.
3. Выполнить команду для регенерации модуля `puzzle`:

   ```bash
   uv run ariadne-codegen
   ```

**Важно:** Запуск `ariadne-codegen` является обязательным шагом перед первым запуском приложения и после любых изменений в файлах `schema.graphql` или `queries.graphql`.

## Обновление схемы

Для обновления схемы потребуется установленное приложение cynic-cli, которое можно установить следующей командой (в системе должен быть установлен [Rust](https://rust-lang.org/tools/install/)):

```shell
cargo install --git https://github.com/obmarg/cynic.git cynic-cli
```

После установки cynic-cli выполните в shell команду `./get-schema.sh > schema.graphql`, в корне репозитория. Этот скрипт выполнит аутентификацию на сервере Puzzle и скачает актуальную схему GraphQL в файл `schema.graphql`.

Чтобы скрипт успешно выполнился, необходимо предварительно задать в файле `.env` переменные:
- `PUZZLE_API` — URL GraphQL API сервера Puzzle.
- `PUZZLE_USER_DOMAIN` — домен студии, пустой, если домен не используется.
- `PUZZLE_USERNAME` — имя пользователя.
- `PUZZLE_PASSWORD` — пароль пользователя.

Опционально можно задать переменную окружения `LOG_LEVEL` для управления уровнем логирования (например, `LOG_LEVEL=INFO`).

пример файла `.env` приведен в `example.env`.